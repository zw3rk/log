<!DOCTYPE html>
<html lang="en-us">
    <head>
		
		
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>The tail of an off-by-one error in GHC&#39;s linker &middot; log.zw3rk.com</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="/css/fonts.css">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="log.zw3rk.com" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">log.zw3rk.com</h2>
				</a>
				<ul>
    
    
        <li>
            <a href="/about/">
                
                <span>About</span>
                
            </a>
        </li>
    
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        Moritz
        <br>
        <span>on&nbsp;</span><time datetime="2021-06-28 00:00:00 &#43;0800 &#43;08">June 28, 2021</time>
</div>

		<h1 class="post-title">The tail of an off-by-one error in GHC&#39;s linker</h1>
<div class="post-line"></div>

		

		<p>This is the story of an odd off-by-one error in GHC&rsquo;s internal static
linker for the Mach-O file format on AArch64.  This is our beloved
macOS/iOS platform!</p>
<p>For a while we have been observing odd non-deterministic failures in
<a href="https://gitlab.haskell.org">CI</a>.  We&rsquo;d see a bunch of test for the aarch64-darwin runner fail, but
rarely the same, and if re-run different tests would fail.  The only
observable correlation was that the failing tests all somehow had to
do with <code>iserv</code>, ghc&rsquo;s external interpreter.  This did hint towards an
issue in the linker, but no clear indication what was really the
fundamental problem.</p>
<p>While Matthew Pickering and I eventually managed to isolate tests
from the test-suite that had slightly higher failure rates (e.g. they&rsquo;d
fail every other or so time), getting the failure into the debugger
didn&rsquo;t help much.  We&rsquo;d just have a crash in invalid memory. SIGBUS.
The program counter would have advanced too far to be useful, we
didn&rsquo;t know where we came from.  This is especially the case for code
GHC generates for Haskell.  We don&rsquo;t really &ldquo;return&rdquo;, but have
knowledge of where we&rsquo;d eventually want to continue, thus assembly
generated by GHC makes lots of use of (un)conditional branch
instructions, but rarely branch and link instructions that would
record the caller in the link register; and permit to return.</p>
<p>We don&rsquo;t really have <code>rr</code> yet on aarch64-darwin to my knowledge, nor
does <code>lldb</code> support something akin to <code>gdb</code>&rsquo;s record feature.  And of
course we don&rsquo;t have <code>gcc/gdb</code> on aarch64-darwin just yet.</p>
<p>So what we really want is to be able to record where we come from, but
we also do not want to mess with the link register, otherwise we&rsquo;d
likely break unrelated code.  Let&rsquo;s go swimming.  While meditating on
this issue for a bit, I did remember that we reserved a register <code>r16</code>
for spill/reload offset computations that were too large to
handle. (AArch64 can&rsquo;t do arbitrary offsets as immediate, so we
occasionally need to add two registers together to obtain the offset
value we want).  We only care about the registers value for a branch
instruction, thus it&rsquo;s outside of any spill/reload computations.
Looks like we can use <code>r16</code>.  After modifying the aarch64 codegen to
write the current program location into <code>r16</code> prior to any branch
instruction via <code>ADR x16 .</code>, we should now be able to inspect <code>r16</code> when
we hit SIGBUS in the debugger again.  After a rebuild, and a few tries
to get the crash into the debugger, we are presented with the
following debug session:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">(lldb) p/x $x16
(unsigned long) $11 = 0x000000010ff99d54
(lldb) p/x $pc
(unsigned long) $12 = 0x0000000108384658
(lldb) dis -s $x16-0x20 -c 20
    0x10ff99d34: cmp    x18, x28
    0x10ff99d38: adr    x16, #0x0
    0x10ff99d3c: b.lo   0x10ff99dbc
    0x10ff99d40: adrp   x18, 0
    0x10ff99d44: add    x18, x18, #0xde0          ; =0xde0
    0x10ff99d48: stur   x18, [x20, #-0x10]
    0x10ff99d4c: stur   x24, [x20, #-0x8]
    0x10ff99d50: sub    x20, x20, #0x10           ; =0x10
    0x10ff99d54: adr    x16, #0x0
    0x10ff99d58: b      0x108384658
    0x10ff99d5c: mov    w18, #0x10
    0x10ff99d60: str    x18, [x19, #0x388]
    0x10ff99d64: adr    x16, #0x0
    0x10ff99d68: b      0x10ff9e57c
    0x10ff99d6c: udf    #0x1
    0x10ff99d70: udf    #0x0
    0x10ff99d74: udf    #0x1e
    0x10ff99d78: udf    #0x0
    0x10ff99d7c: add    x21, x21, #0x10           ; =0x10
    0x10ff99d80: ldr    x18, [x19, #0x358]
</code></pre></div><p>We can see we ended up in <code>0x108384658</code>, which is where the
unconditional branch instruction in <code>0x10ff99d58</code>, which is following
our <code>adr x16, 0x0</code> instruction as expected.</p>
<p>I&rsquo;ve ran the experiment a few more times to make sure all the crashes
looked sufficiently similar and we&rsquo;d unlikely have to deal with a
variety of odd crashes that just happened to present themselves quite
similar.</p>
<p>Now we have an address, but we don&rsquo;t know where this actually came
from.  GHC&rsquo;s Run Time System has a function called <code>printLoadedObjects</code>,
which when invoked will print a table of all object files the internal
linker loaded into memory.  (Again I couldn&rsquo;t get <code>lldb</code> to execute that
function, so I ended up just printing all loaded objects after each
symbol resolution pass&hellip;)</p>
<p>The output of <code>printLoadedObjects</code> looks like this (just a lot more)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">_build/stage1/lib/aarch64-osx-ghc-9.3.20210621/template-haskell-2.18.0.0/libHStemplate-haskell-2.18.0.0.a(Internal.o)
      sec  0[alloc: 2; kind: 0]: 0x10ff70000 - 0x10ff9e538; mmaped: 0x10ff70000 - 0x10ffa8000
      sec  1[alloc: 2; kind: 1]: 0x10efe0000 - 0x10efe1098; mmaped: 0x10efe0000 - 0x10efe4000
      sec  2[alloc: 2; kind: 4]: 0x10efe4000 - 0x10efe40b6; mmaped: 0x10efe4000 - 0x10efe8000
</code></pre></div><p>We know we called from <code>0x10ff99d58</code>, which is in the first (section 0),
of the <code>Internal.o</code> file from <code>template-haskell</code>.  Disassembling
<code>Internal.o</code> to verify we found the right location yields the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">_templatezmhaskell_LanguageziHaskellziTHziLibziInternal_litE_info:
0000000000029d30	sub	x18, x20, #0x10
0000000000029d34	cmp	x18, x28                        ; Latency: 2
0000000000029d38	adr	x16, #0x0
0000000000029d3c	b.lo	0x29dbc
0000000000029d40	adrp	x18, 0 ; 0x29000
0000000000029d44	add	x18, x18, #0x0
0000000000029d48	stur	x18, [x20, #-0x10]              ; Latency: 4
0000000000029d4c	stur	x24, [x20, #-0x8]               ; Latency: 4
0000000000029d50	sub	x20, x20, #0x10
0000000000029d54	adr	x16, #0x0
0000000000029d58	b	0x29d58
0000000000029d5c	mov	w18, #0x10
0000000000029d60	str	x18, [x19, #0x388]              ; Latency: 4
0000000000029d64	adr	x16, #0x0
0000000000029d68	b	0x29d68
0000000000029d6c	udf	#0x1
0000000000029d70	udf	#0x0
0000000000029d74	udf	#0x1e
0000000000029d78	udf	#0x0
</code></pre></div><p>This looks rather promising and is exactly where we had our crash. So
what happened?</p>
<h2 id="interlude-relocations">Interlude: Relocations</h2>
<p>Relocations are records in object files that the linker can use to
resolve symbols.  This is important as we do not know where the final
symbol might end up in memory, and thus need a way to reference a
symbol for which we do not know its resting place.  We therefore
record symbolic pointers.  The linkers job is then to resolve those
pointers.  The pointer contains a location where we need to patch up
an address, the name of the symbol that we want to point to, and one
of a few pre-defined relocation types.  The linker has to iterate over
all relocation after it loaded an object, for each object it loads.</p>
<p>We can ask <code>otool</code> for relocations, and providing <code>-v</code> we&rsquo;ll get some
easier to read nameing as well.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">address  pcrel length extern type    scattered symbolnum/value
00029d58 True  long   True   BR26    False     _stg_gc_unpt_r1
</code></pre></div><p>So for <code>0x29d58</code> (relative to the resting place of the object file in
memory), there is a BR26 (Branch 26) relocation, that points to the
Extern symbol <code>_stg_gc_unpt_r1</code>. And this is what we&rsquo;d end up patching
up in the object file.  This somehow goes wrong.</p>
<p>Let&rsquo;s look at the broken relocation again: We jump to <code>0x108384658</code> from
<code>0x10ff99d58</code>, so the relative value in the branch instruction is
<code>0x108384658 - 0x10ff99d58 = 0xf83EA900</code>. Not the leading <code>0xf</code>?, yes
that&rsquo;s a negative value.  Let&rsquo;s look at it in binary and we see</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">1111 1000 0011 1110 1010 1001 0000 0000
|         |         |         |       |
31        23        15        7       0
</code></pre></div><p>The BR26 relocation can encode 26 bits of relocation information
(e.g. encode them right in the Branch instruction). However due to
guaranteed alignment on 4 bytes, we do not need to encode the last
two bits as they will always be zero. This gives us a range
of 28. Which however needs to include the sign bit. So we can really
only encode values in the range of <code>+-2^27</code>.  For values outside of this
range we&rsquo;ll create a forward jump to the final destination, that is
reachable.  At this point we might already have a good idea why this
failed.  And yes, the linker did check for <code>+-2^28</code>, and thus when we
just happened to hit a positive value with the 28th bit set, we&rsquo;d
write it into the relocation, and call it a day.  Just for the CPU to
read it as a negative jump and jump to a random address.</p>
<p>Thus the <a href="https://gitlab.haskell.org/ghc/ghc/-/merge%5Frequests/6041/diffs">final fix</a> was just an additional <code>-1</code>, to the range check for
relocations of the <code>BR26</code> type.  And thus we can conclude the mystery of
the random crashes on aarch64-darwin (macOS), and the story of an odd
off-by-one error in GHC&rsquo;s in-memory linker.</p>
<p>On a final note: if you like this write up and want to support this
work as well as GHC&rsquo;s Continuous Integration, and you also happen hold
Cardanos Crypto Currency ADA, I&rsquo;d like to invite you to stake your ADA
with the <a href="https://adapools.org/pool/e2c17915148f698723cb234f3cd89e9325f40b89af9fd6e1f9d1701a">ZW3RK</a> pool. It is a very competitive 1% pool, and operational
rewards will go towards operating part of GHC&rsquo;s CI infrastructure and
write ups like these.</p>


		
	</div>

	<div class="pagination">
		<a href="/posts/2018-10-09-what-is-new-in-cross-compiling-haskell/" class="left arrow">&#8592;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			
			<span>
			&copy; <time datetime="2021-06-28 18:22:53.461127 &#43;0800 &#43;08 m=&#43;0.065610260">2021</time> Moritz Angermann. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
